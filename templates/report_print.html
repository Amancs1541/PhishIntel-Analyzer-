<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PhishGuard Report #{{ email.id }} Print View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
        font-family: 'Inter', sans-serif;
        color: #000;
        margin: 0;
        padding: 20px;
    }
    /* Hide the Chart canvas on print, replace with data table */
    #riskChart { display: none !important; }
    /* Simplify containers for print */
    .card {
        border: 1px solid #ccc;
        box-shadow: none;
        margin-bottom: 20px;
        border-radius: 0;
    }
    .badge {
        /* Ensure badges are readable in B&W */
        border: 1px solid #000;
        color: #000 !important;
        background-color: #f0f0f0 !important;
    }
    /* Ensure only print-specific styles apply */
    @media print {
        body { margin: 0; padding: 0; }
        .container { max-width: 100%; padding: 0 10px; }
        .d-print-none { display: none !important; }
    }
  </style>
</head>
<body onload="window.print()">

<main class="container">
    <h1 class="mb-5 fw-bold text-center">PhishGuard Analysis Report #{{ email.id }}</h1>
    <p class="text-end small">Generated: {{ logs[0].ts if logs else 'N/A' }}</p>

    <div class="row g-4 mb-5">
      
      <div class="col-6">
        <div class="card p-3">
            <h5 class="card-title fw-semibold">Email Metadata</h5>
            <hr class="text-muted">
            <dl class="row mb-0 small">
              <dt class="col-sm-4">Subject</dt><dd class="col-sm-8">{{ email.subject }}</dd>
              <dt class="col-sm-4">Sender</dt><dd class="col-sm-8">{{ email.sender }}</dd>
              <dt class="col-sm-4">Status</dt><dd class="col-sm-8">{{ email.status }}</dd>
              <dt class="col-sm-4">NLP Score</dt><dd class="col-sm-8">{{ email.nlp_score }}</dd>
            </dl>
        </div>
      </div>

      {% if report and report.combined %}
      <div class="col-6">
        <div class="card p-3 text-center">
            <h5 class="card-title fw-bold">Final Verdict</h5>
            <div class="my-3">
              <span class="badge fs-5 text-uppercase px-4 py-2">
                {{ report.combined.verdict }}
              </span>
            </div>
            <div class="row mt-4">
              <div class="col">
                <p class="mb-0 small">Risk Score</p>
                <p class="fw-bold fs-4">{{ report.combined.risk_final }}</p>
              </div>
              <div class="col border-start">
                <p class="mb-0 small">Confidence</p>
                <p class="fw-bold fs-4">{{ report.combined.confidence }}%</p>
              </div>
            </div>
        </div>
      </div>
      
      <div class="col-12">
        <h4 class="mt-4 fw-semibold">Risk Contribution Breakdown</h4>
        <table class="table table-bordered table-sm small">
            <thead>
                <tr><th>Source</th><th>NLP</th><th>VirusTotal</th><th>OTX</th><th>AbuseIPDB</th><th>Heuristic</th></tr>
            </thead>
            <tbody>
                <tr>
                    <th>Risk Score</th>
                    <td>{{ report.combined.signals.nlp.risk }}</td>
                    <td>{{ report.combined.signals.vt.risk }}</td>
                    <td>{{ report.combined.signals.otx.risk }}</td>
                    <td>{{ report.combined.signals.abuseipdb.risk }}</td>
                    <td>{{ report.combined.signals.heuristic.risk }}</td>
                </tr>
            </tbody>
        </table>
      </div>
    </div>
    {% endif %}


    <h2 class="mt-4 mb-3 fw-bold">Indicators of Compromise (IOCs)</h2>
    
    {% if report and report.report.urls %}
    <h4 class="fw-semibold mt-4">URLs</h4>
    <table class="table table-striped table-sm small">
      <thead><tr><th>URL</th><th>Defanged</th><th>VT Malicious</th><th>OTX Pulses</th></tr></thead>
      <tbody>
        {% for u in report.report.urls %}
        <tr>
          <td>{{ u.url }}</td>
          <td>{{ u.defanged }}</td>
          <td>{{ u.vt_malicious }}</td>
          <td>{{ u.otx_pulses }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    {% if report and report.report.ips %}
    <h4 class="fw-semibold mt-4">IPs</h4>
    <table class="table table-striped table-sm small">
      <thead><tr><th>IP</th><th>Defanged</th><th>VT Malicious</th><th>Abuse Score</th><th>OTX Pulses</th></tr></thead>
      <tbody>
        {% for ip, data in report.report.ips.items() %}
        <tr>
          <td>{{ ip }}</td>
          <td>{{ data.defanged }}</td>
          <td>{{ data.vt_malicious }}</td>
          <td>{{ data.abuse_score }}</td>
          <td>{{ data.otx_pulses }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    
    {% if report and report.report.domains %}
    <h4 class="fw-semibold mt-4">Domains</h4>
    <table class="table table-striped table-sm small">
      <thead><tr><th>Domain</th><th>Defanged</th><th>VT Malicious</th><th>OTX Pulses</th><th>Status</th></tr></thead>
      <tbody>
        {% for d in report.report.domains %}
        <tr>
          <td>{{ d.domain }}</td>
          <td>{{ d.defanged }}</td>
          <td>{{ d.vt_malicious }}</td>
          <td>{{ d.otx_pulses }}</td>
          <td>{{ d.status }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    {% if report and report.report.hashes %}
    <h4 class="fw-semibold mt-4">Hashes</h4>
    <table class="table table-striped table-sm small">
      <thead><tr><th>Hash</th><th>VT Malicious</th><th>OTX Pulses</th></tr></thead>
      <tbody>
        {% for h in report.report.hashes %}
        <tr>
          <td>{{ h.hash }}</td>
          <td>{{ h.vt_malicious }}</td>
          <td>{{ h.otx_pulses }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    <h2 class="mt-5 mb-3 fw-bold">Activity Logs</h2>
    <ul class="list-group list-group-flush small">
      {% for l in logs %}
        <li class="list-group-item">{{ l.ts }} [{{ l.level }}] {{ l.source }}: {{ l.message }}</li>
      {% endfor %}
    </ul>

</main>

<script>
    // Automatically trigger the print dialog when the page loads
    window.onload = function() {
        // Give a moment for the content to fully render, then print
        setTimeout(function() {
            window.print();
        }, 500);
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>