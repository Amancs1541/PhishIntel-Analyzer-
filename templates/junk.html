<!-- templates/report_detail.html -->
{% extends "base.html" %}{% block title %}Report{% endblock %}{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3>Email Analysis Report</h3>
  <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title">Summary</h5>
    <div class="row">
      <div class="col-md-8">
        <p><strong>Subject:</strong> {{ email.subject or '(no subject)' }}</p>
        <p><strong>Sender:</strong> {{ email.sender }}</p>
        <p><strong>Sender domain:</strong> {{ email.sender_domain or '-' }}</p>
        <p><strong>Received IPs:</strong> {{ email.received_ip or '-' }}</p>
      </div>
      <div class="col-md-4">
        <p><strong>Verdict:</strong>
          <span class="badge bg-{% if email.verdict=='phishing' %}danger{% elif email.verdict=='suspicious' %}warning{% else %}success{% endif %}">
            {{ email.verdict or 'pending' }}
          </span>
        </p>
        <p><strong>NLP score:</strong> {{ "%.2f"|format(email.nlp_score or 0.0) }}</p>
        <p><strong>Providers:</strong>
          {% set p = report.get('providers', {}) %}
          <span class="badge bg-{{ 'success' if p.get('vt') else 'secondary' }}">VT</span>
          <span class="badge bg-{{ 'success' if p.get('abuse') else 'secondary' }}">AbuseIPDB</span>
          <span class="badge bg-{{ 'success' if p.get('otx') else 'secondary' }}">OTX</span>
        </p>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title">Detection summary</h5>
    <p class="mb-3">
      <span class="badge bg-danger me-2">Malicious: {{ report.get('summary', {}).get('malicious', 0) }}</span>
      <span class="badge bg-warning text-dark me-2">Suspicious: {{ report.get('summary', {}).get('suspicious', 0) }}</span>
      <span class="badge bg-success">Clean: {{ report.get('summary', {}).get('clean', 0) }}</span>
    </p>
    <canvas id="summaryChart" height="120"></canvas>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-lg-6">
    <div class="card shadow-sm"><div class="card-body">
      <h5 class="card-title">URLs</h5>
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead class="table-light"><tr><th>Defanged URL</th><th>VT malicious</th><th>OTX pulses</th><th>Status</th></tr></thead>
          <tbody>
            {% for u in report.get('urls',[]) %}
            <tr>
              <td><code>{{ u.defanged }}</code></td>
              <td>{{ u.vt_malicious }}</td>
              <td>{{ u.otx_pulses }}</td>
              <td>{% if u.status=='detected' %}<span class="badge bg-danger">detected</span>{% else %}<span class="badge bg-success">clean</span>{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div></div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm"><div class="card-body">
      <h5 class="card-title">IPs</h5>
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead class="table-light"><tr><th>Defanged IP</th><th>VT malicious</th><th>Abuse score</th><th>OTX pulses</th><th>Status</th></tr></thead>
          <tbody>
            {% for ip, d in report.get('ips',{}).items() %}
            <tr>
              <td><code>{{ d.defanged }}</code></td>
              <td>{{ d.vt_malicious }}</td>
              <td>{{ d.abuse_score }}</td>
              <td>{{ d.otx_pulses }}</td>
              <td>{% if d.status=='detected' %}<span class="badge bg-danger">detected</span>{% else %}<span class="badge bg-success">clean</span>{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div></div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-lg-6">
    <div class="card shadow-sm"><div class="card-body">
      <h5 class="card-title">Domains</h5>
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead class="table-light"><tr><th>Defanged domain</th><th>OTX pulses</th><th>Status</th></tr></thead>
          <tbody>
            {% for d in report.get('domains',[]) %}
            <tr>
              <td><code>{{ d.defanged }}</code></td>
              <td>{{ d.otx_pulses }}</td>
              <td>{% if d.status=='detected' %}<span class="badge bg-danger">detected</span>{% else %}<span class="badge bg-success">clean</span>{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div></div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm"><div class="card-body">
      <h5 class="card-title">Hashes (attachments)</h5>
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead class="table-light"><tr><th>SHA256</th><th>VT malicious</th><th>OTX pulses</th><th>Status</th></tr></thead>
          <tbody>
            {% for h in report.get('hashes',[]) %}
            <tr>
              <td><code>{{ h.hash }}</code></td>
              <td>{{ h.vt_malicious }}</td>
              <td>{{ h.otx_pulses }}</td>
              <td>{% if h.status=='detected' %}<span class="badge bg-danger">detected</span>{% else %}<span class="badge bg-success">clean</span>{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div></div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title">Headers</h5>
    <pre class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ email.headers_json }}</pre>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="card-title">Activity log</h5>
    <ul class="list-group small">
      {% for l in logs %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>[{{ l.ts.strftime('%Y-%m-%d %H:%M:%S') }}] {{ l.source|upper }}: {{ l.message }}</span>
        <span class="badge bg-{% if l.level=='error' %}danger{% elif l.level=='warn' %}warning text-dark{% else %}secondary{% endif %}">{{ l.level }}</span>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
const ctx = document.getElementById('summaryChart');
const dataMal = {{ report.get('summary', {}).get('malicious', 0) }};
const dataSusp = {{ report.get('summary', {}).get('suspicious', 0) }};
const dataClean = {{ report.get('summary', {}).get('clean', 0) }};
new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Malicious', 'Suspicious', 'Clean'],
    datasets: [{ data: [dataMal, dataSusp, dataClean], backgroundColor: ['#dc3545','#ffc107','#198754'] }]
  },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});
</script>
{% endblock %}
